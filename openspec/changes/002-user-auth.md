# 变更提案：用户认证模块

## 概述

| 属性 | 值 |
|------|-----|
| 提案编号 | 002 |
| 状态 | ✅ 已完成 |
| 优先级 | 高 |
| 预计工时 | 4小时 |

## 目标

实现用户登录和绑定功能。校长使用预置账号登录，老师/学生通过邀请链接绑定账号。

## 范围

### 页面

```
miniprogram/pages/
├── login/              # 登录页
│   ├── login.js
│   ├── login.json
│   ├── login.wxml
│   └── login.wxss
└── bind/               # 绑定页（接受邀请后绑定账号）
    ├── bind.js
    ├── bind.json
    ├── bind.wxml
    └── bind.wxss
```

### 云函数

```
cloud/functions/
└── user/
    ├── index.js       # 入口
    ├── login.js       # 登录逻辑
    ├── bind.js        # 绑定逻辑
    ├── getPhone.js    # 获取手机号
    └── package.json
```

## 实现细节

### 1. 登录页面

#### 流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                          登录流程                                │
└─────────────────────────────────────────────────────────────────┘

  ┌──────────┐     ┌──────────────┐     ┌──────────────┐
  │  进入    │────▶│  获取手机号   │────▶│  输入密码    │
  │  登录页  │     │  (微信授权)  │     │              │
  └──────────┘     └──────────────┘     └──────────────┘
                                               │
                                               ▼
                   ┌──────────────┐     ┌──────────────┐
                   │  登录成功    │◀────│  调用云函数   │
                   │  跳转首页    │     │  验证密码    │
                   └──────────────┘     └──────────────┘
```

#### 时序图

```
用户                    小程序                   云函数                  数据库
 │                        │                       │                       │
 │── 点击获取手机号 ─────▶│                       │                       │
 │                        │                       │                       │
 │◀── 微信授权弹窗 ───────│                       │                       │
 │                        │                       │                       │
 │──── 确认授权 ─────────▶│                       │                       │
 │                        │─── user/getPhone ───▶│                       │
 │                        │◀── 返回手机号 ────────│                       │
 │                        │                       │                       │
 │◀─── 显示手机号 ────────│                       │                       │
 │                        │                       │                       │
 │──── 输入密码 ─────────▶│                       │                       │
 │                        │                       │                       │
 │──── 点击登录 ─────────▶│                       │                       │
 │                        │───── user/login ─────▶│                       │
 │                        │                       │──── 查询用户 ────────▶│
 │                        │                       │◀─── 用户数据 ─────────│
 │                        │                       │                       │
 │                        │                       │── 验证密码 ──┐        │
 │                        │                       │◀─────────────┘        │
 │                        │◀── 返回用户信息 ──────│                       │
 │                        │                       │                       │
 │◀─── 登录成功,跳转首页 ─│                       │                       │
 │                        │                       │                       │
```

#### UI 设计

```
┌────────────────────────────────┐
│        ◀  登录                 │ ← 导航栏
├────────────────────────────────┤
│                                │
│           📅                   │ ← Logo
│        课程系统                │ ← 应用名称
│                                │
│  ┌────────────────────────┐   │
│  │  📱 获取微信手机号      │   │ ← 授权按钮（未获取）
│  └────────────────────────┘   │
│  或                            │
│  ┌────────────────────────┐   │
│  │  📱 138****0000  更换   │   │ ← 已获取（显示手机号）
│  └────────────────────────┘   │
│                                │
│  ┌────────────────────────┐   │
│  │  🔒 请输入密码          │   │ ← 密码输入框
│  └────────────────────────┘   │
│                                │
│  ┌────────────────────────┐   │
│  │         登 录           │   │ ← 登录按钮
│  └────────────────────────┘   │
│                                │
│   使用微信绑定的手机号登录     │
│                                │
└────────────────────────────────┘
```

#### 适用场景
- **所有用户**：使用微信授权获取手机号 + 密码登录
- 手机号通过微信 getPhoneNumber API 获取，符合微信规范

### 2. 绑定页面

#### 流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                          绑定流程                                │
└─────────────────────────────────────────────────────────────────┘

  ┌──────────┐     ┌──────────────┐     ┌──────────────┐
  │  点击    │────▶│  显示邀请    │────▶│  确认绑定    │
  │  邀请卡片 │     │  信息        │     │              │
  └──────────┘     └──────────────┘     └──────────────┘
                                               │
                                               ▼
  ┌──────────┐     ┌──────────────┐     ┌──────────────┐
  │  绑定    │◀────│  设置密码    │◀────│  获取手机号   │
  │  成功    │     │              │     │  (微信授权)  │
  └──────────┘     └──────────────┘     └──────────────┘
```

#### 状态流转

```
┌─────────┐    确认绑定     ┌─────────┐    获取手机号   ┌─────────┐
│  查看   │ ─────────────▶  │  授权   │ ─────────────▶ │  设置   │
│  邀请   │                 │  手机号 │                │  密码   │
└─────────┘                 └─────────┘                └─────────┘
                                                            │
     ┌──────────────────────────────────────────────────────┘
     │ 提交绑定
     ▼
┌─────────┐    调用云函数    ┌─────────┐    更新状态    ┌─────────┐
│  验证   │ ─────────────▶  │  绑定   │ ─────────────▶ │  完成   │
│   中    │                 │  成功   │                │  登录   │
└─────────┘                 └─────────┘                └─────────┘
```

#### UI 设计

```
┌────────────────────────────────┐
│        ◀  绑定账号             │ ← 导航栏
├────────────────────────────────┤
│                                │
│  ┌────────────────────────┐   │
│  │      邀请信息           │   │
│  │                        │   │
│  │  👤 张校长 邀请您       │   │
│  │     成为「数学老师」    │   │
│  │                        │   │
│  │  姓名：李老师           │   │
│  │  科目：数学             │   │
│  └────────────────────────┘   │
│                                │
│  ┌────────────────────────┐   │
│  │  📱 获取微信手机号      │   │ ← 手机号按钮
│  └────────────────────────┘   │
│                                │
│  ┌────────────────────────┐   │
│  │  🔒 设置登录密码        │   │ ← 密码输入
│  └────────────────────────┘   │
│  ┌────────────────────────┐   │
│  │  🔒 确认登录密码        │   │ ← 确认密码
│  └────────────────────────┘   │
│                                │
│  ┌────────────────────────┐   │
│  │       确认绑定          │   │ ← 绑定按钮
│  └────────────────────────┘   │
│                                │
└────────────────────────────────┘
```

### 3. 云函数 - user

#### login
```javascript
// 入参
{
  phone: "手机号",
  password: "密码"
}

// 返回（成功）
{
  success: true,
  data: {
    userId: "用户ID",
    role: "principal|teacher|student",
    name: "姓名",
    token: "登录凭证"
  }
}

// 返回（失败）
{
  success: false,
  code: "USER_NOT_FOUND|WRONG_PASSWORD|NOT_BINDABLE",
  message: "错误信息"
}
```

#### bind
```javascript
// 入参
{
  inviteCode: "邀请码",
  phone: "手机号",
  password: "密码"
}

// 处理逻辑
// 1. 验证邀请码有效性
// 2. 检查手机号是否已被使用
// 3. 更新用户记录（填充 phone, password, _openid）
// 4. 更新用户 bindStatus 为 'bound'
// 5. 更新邀请记录状态为 'accepted'

// 返回
{
  success: true,
  data: {
    userId: "用户ID",
    role: "角色",
    name: "姓名",
    token: "登录凭证"
  }
}
```

#### getPhone
```javascript
// 入参
{
  code: "手机号获取凭证"
}

// 返回
{
  success: true,
  data: {
    phone: "解密后的手机号"
  }
}
```

### 4. 数据库操作

#### 登录查询
```javascript
// 根据手机号查询已绑定用户
db.collection('users').where({
  phone: phone,
  bindStatus: 'bound'
}).get()
```

#### 绑定更新
```javascript
// 更新用户记录
db.collection('users').doc(userId).update({
  _openid: openid,
  phone: phone,
  password: hashedPassword,
  bindStatus: 'bound',
  _updateTime: new Date()
})
```

### 5. 安全考虑

- 邀请码有效期验证
- 手机号防重复绑定

## 验收标准

- [ ] 校长可使用预置账号登录
- [ ] 已绑定用户可使用手机号+密码登录
- [ ] 通过邀请链接可进入绑定页面
- [ ] 绑定时可获取微信手机号
- [ ] 绑定成功后自动登录
- [ ] 登录状态持久化

## 依赖

- 001-init-project.md（已完成）

## 后续提案

- 003-user-bindable.md：用户管理与邀请绑定
