<!--pages/schedule/create/create.wxml-->
<custom-navbar title="{{isEdit ? 'ç¼–è¾‘æ’è¯¾' : 'åˆ›å»ºæ’è¯¾'}}"></custom-navbar>
<view class="container">
  <view class="form-card">
    <!-- è¯¾ç¨‹åç§° -->
    <view class="form-item">
      <view class="form-label required">è¯¾ç¨‹åç§°</view>
      <input 
        class="form-input" 
        placeholder="è¯·è¾“å…¥è¯¾ç¨‹åç§°" 
        value="{{formData.courseName}}"
        bindinput="onInput"
        data-field="courseName"
      />
    </view>

    <!-- æˆè¯¾æ•™å¸ˆ - æ ¡é•¿å¯é€‰æ‹©ï¼Œè€å¸ˆè‡ªåŠ¨ä¸ºè‡ªå·± -->
    <view class="form-item" wx:if="{{isPrincipal}}">
      <view class="form-label required">æˆè¯¾æ•™å¸ˆ</view>
      <picker 
        mode="selector" 
        range="{{teacherList}}" 
        range-key="name"
        value="{{teacherIndex}}"
        bindchange="onTeacherChange"
      >
        <view class="form-picker {{formData.teacherId ? '' : 'placeholder'}}">
          {{formData.teacherName || 'è¯·é€‰æ‹©æˆè¯¾æ•™å¸ˆ'}}
          <text class="picker-arrow">â€º</text>
        </view>
      </picker>
    </view>

    <!-- è€å¸ˆæ˜¾ç¤ºè‡ªå·± -->
    <view class="form-item" wx:elif="{{isTeacher}}">
      <view class="form-label">æˆè¯¾æ•™å¸ˆ</view>
      <view class="form-static">{{currentUser.name}}ï¼ˆæœ¬äººï¼‰</view>
    </view>

    <!-- æ—¥æœŸé€‰æ‹© -->
    <view class="form-item">
      <view class="form-label required">ä¸Šè¯¾æ—¥æœŸ</view>
      <picker 
        mode="date" 
        value="{{formData.date}}"
        bindchange="onDateChange"
      >
        <view class="form-picker {{formData.date ? '' : 'placeholder'}}">
          {{formData.date || 'è¯·é€‰æ‹©æ—¥æœŸ'}}
          <text class="picker-arrow">â€º</text>
        </view>
      </picker>
    </view>

    <!-- æ—¶é—´/æ—¶é•¿é€‰æ‹© -->
    <view class="form-row">
      <view class="form-item half">
        <view class="form-label required">å¼€å§‹æ—¶é—´</view>
        <picker 
          mode="selector" 
          range="{{startTimeOptions}}" 
          value="{{startTimeIndex}}"
          bindchange="onStartTimeChange"
        >
          <view class="form-picker {{formData.startTime ? '' : 'placeholder'}}">
            {{formData.startTime || 'å¼€å§‹'}}
            <text class="picker-arrow">â€º</text>
          </view>
        </picker>
      </view>

      <view class="form-item half">
        <view class="form-label required">æ—¶é•¿</view>
        <picker 
          mode="selector" 
          range="{{durationOptions}}" 
          value="{{durationIndex}}"
          bindchange="onDurationChange"
        >
          <view class="form-picker">
            {{durationOptions[durationIndex]}}
            <text class="picker-arrow">â€º</text>
          </view>
        </picker>
      </view>
    </view>

    <!-- ä¸Šè¯¾åœ°ç‚¹ -->
    <view class="form-item">
      <view class="form-label">ä¸Šè¯¾åœ°ç‚¹</view>
      <input 
        class="form-input" 
        placeholder="è¯·è¾“å…¥ä¸Šè¯¾åœ°ç‚¹ï¼ˆé€‰å¡«ï¼‰" 
        value="{{formData.location}}"
        bindinput="onInput"
        data-field="location"
      />
    </view>

    <!-- å­¦ç”Ÿé€‰æ‹© -->
    <view class="form-item">
      <view class="form-label required">å‚ä¸å­¦ç”Ÿ</view>
      <view class="student-selector" bindtap="openStudentPicker">
        <view class="selected-students" wx:if="{{selectedStudents.length > 0}}">
          <view class="student-tag" wx:for="{{selectedStudents}}" wx:key="_id">
            {{item.name}}
          </view>
        </view>
        <view class="placeholder" wx:else>ç‚¹å‡»é€‰æ‹©å­¦ç”Ÿï¼ˆé€‰å¡«ï¼‰</view>
        <text class="picker-arrow">â€º</text>
      </view>
    </view>

    <!-- å¤‡æ³¨ -->
    <view class="form-item">
      <view class="form-label">å¤‡æ³¨</view>
      <textarea 
        class="form-textarea" 
        placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯ï¼ˆé€‰å¡«ï¼‰" 
        value="{{formData.remark}}"
        bindinput="onInput"
        data-field="remark"
        maxlength="200"
      />
    </view>
  </view>

  <!-- æäº¤æŒ‰é’® -->
  <view class="btn-area">
    <button 
      class="btn-submit {{isSubmitting ? 'disabled' : ''}}" 
      bindtap="handleSubmit"
      disabled="{{isSubmitting}}"
    >
      {{isSubmitting ? 'ä¿å­˜ä¸­...' : (isEdit ? 'ä¿å­˜ä¿®æ”¹' : 'åˆ›å»ºæ’è¯¾')}}
    </button>
  </view>
</view>

<!-- å­¦ç”Ÿé€‰æ‹©å¼¹çª— -->
<view class="modal-mask" wx:if="{{showStudentPicker}}" bindtap="closeStudentPicker"></view>
<view class="modal-content {{showStudentPicker ? 'show' : ''}}">
  <view class="modal-header">
    <text class="modal-title">é€‰æ‹©å­¦ç”Ÿ</text>
    <view class="modal-header-actions">
      <view class="add-student-btn" bindtap="goAddStudent">
        <text class="add-icon">+</text>
        <text>æ·»åŠ å­¦ç”Ÿ</text>
      </view>
      <view class="modal-close" bindtap="closeStudentPicker">âœ•</view>
    </view>
  </view>
  <view class="modal-body">
    <view class="student-list" wx:if="{{studentList.length > 0}}">
      <view 
        class="student-item {{item.selected ? 'selected' : ''}}" 
        wx:for="{{studentList}}" 
        wx:key="_id"
        bindtap="toggleStudent"
        data-index="{{index}}"
      >
        <view class="student-checkbox">
          <text wx:if="{{item.selected}}">âœ“</text>
        </view>
        <view class="student-info">
          <text class="student-name">{{item.name}}</text>
        </view>
      </view>
    </view>
    <view class="empty-list" wx:else>
      <view class="empty-icon">ğŸ“š</view>
      <text>æš‚æ— å­¦ç”Ÿ</text>
      <view class="empty-add-btn" bindtap="goAddStudent">ç‚¹å‡»æ·»åŠ å­¦ç”Ÿ</view>
    </view>
  </view>
  <view class="modal-footer">
    <button class="btn-confirm" bindtap="confirmStudents">ç¡®å®š ({{selectedCount}}äºº)</button>
  </view>
</view>


